ALTER SESSION SET CONTAINER = XEPDB1;

BEGIN
   EXECUTE IMMEDIATE '
      CREATE USER HOSPITAL_USER
      IDENTIFIED BY hospital
      DEFAULT TABLESPACE USERS
      TEMPORARY TABLESPACE TEMP
   ';
   DBMS_OUTPUT.PUT_LINE('Usuari HOSPITAL_USER creat.');
EXCEPTION
   WHEN OTHERS THEN
      IF SQLCODE = -1920 THEN
         DBMS_OUTPUT.PUT_LINE('Usuari HOSPITAL_USER ja existeix.');
      ELSE
         RAISE;
      END IF;
END;
/

BEGIN
   EXECUTE IMMEDIATE 'GRANT CREATE SESSION TO HOSPITAL_USER';
   EXECUTE IMMEDIATE 'GRANT CREATE TABLE, CREATE SEQUENCE, CREATE VIEW, CREATE PROCEDURE TO HOSPITAL_USER';
   EXECUTE IMMEDIATE 'GRANT UNLIMITED TABLESPACE TO HOSPITAL_USER';
   EXECUTE IMMEDIATE 'ALTER USER HOSPITAL_USER QUOTA UNLIMITED ON USERS';
   DBMS_OUTPUT.PUT_LINE('Privilegis i quota assignats correctament a HOSPITAL_USER.');
EXCEPTION
   WHEN OTHERS THEN
      DBMS_OUTPUT.PUT_LINE('Error assignant privilegis: ' || SQLERRM);
END;
/

BEGIN
   EXECUTE IMMEDIATE '
      CREATE TABLE HOSPITAL_USER.PATIENT (
         ID NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
         NHSID VARCHAR2(50),
         FIRSTNAME VARCHAR2(100),
         LASTNAME VARCHAR2(100)
      ) TABLESPACE USERS
   ';
   DBMS_OUTPUT.PUT_LINE('Taula PATIENT creada.');
EXCEPTION
   WHEN OTHERS THEN
      IF SQLCODE = -955 THEN
         DBMS_OUTPUT.PUT_LINE('Taula PATIENT ja existeix.');
      ELSE
         RAISE;
      END IF;
END;
/

DECLARE
   v_count NUMBER;
BEGIN
   SELECT COUNT(*) INTO v_count FROM HOSPITAL_USER.PATIENT;
   IF v_count = 0 THEN
      INSERT INTO HOSPITAL_USER.PATIENT (NHSID, FIRSTNAME, LASTNAME) VALUES ('NHS001', 'Anna', 'Serra');
      INSERT INTO HOSPITAL_USER.PATIENT (NHSID, FIRSTNAME, LASTNAME) VALUES ('NHS002', 'Marc', 'Pujol');
      INSERT INTO HOSPITAL_USER.PATIENT (NHSID, FIRSTNAME, LASTNAME) VALUES ('NHS003', 'Jordi', 'Casas');
      INSERT INTO HOSPITAL_USER.PATIENT (NHSID, FIRSTNAME, LASTNAME) VALUES ('NHS004', 'Marta', 'Ribas');
      INSERT INTO HOSPITAL_USER.PATIENT (NHSID, FIRSTNAME, LASTNAME) VALUES ('NHS005', 'Pau', 'Vidal');
      INSERT INTO HOSPITAL_USER.PATIENT (NHSID, FIRSTNAME, LASTNAME) VALUES ('NHS006', 'Laura', 'Roca');
      INSERT INTO HOSPITAL_USER.PATIENT (NHSID, FIRSTNAME, LASTNAME) VALUES ('NHS007', 'Oriol', 'Ruiz');
      INSERT INTO HOSPITAL_USER.PATIENT (NHSID, FIRSTNAME, LASTNAME) VALUES ('NHS008', 'Carla', 'Solé');
      INSERT INTO HOSPITAL_USER.PATIENT (NHSID, FIRSTNAME, LASTNAME) VALUES ('NHS009', 'Nil', 'Costa');
      INSERT INTO HOSPITAL_USER.PATIENT (NHSID, FIRSTNAME, LASTNAME) VALUES ('NHS010', 'Júlia', 'Ferrer');
      COMMIT;
      DBMS_OUTPUT.PUT_LINE('Dades de prova inserides a PATIENT.');
   ELSE
      DBMS_OUTPUT.PUT_LINE('La taula PATIENT ja té dades.');
   END IF;
END;
/

SET FEEDBACK ON
SET SERVEROUTPUT ON

SELECT table_name FROM all_tables WHERE owner = 'HOSPITAL_USER';

SELECT * FROM HOSPITAL_USER.PATIENT;

EXIT;
